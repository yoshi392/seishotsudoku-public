<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è–æ›¸é€šèª­</title>
  <link rel="manifest" href="./manifest.webmanifest" />
</head>
<body>
  <main style="font-family:system-ui;max-width:720px;margin:24px auto;padding:0 16px;">
    <h1>è–æ›¸é€šèª­</h1>
    <button id="btnEnablePush">ğŸ”” é€šçŸ¥ã‚’å—ã‘å–ã‚‹</button>
    <div id="pushStatus" style="margin-top:8px;"></div>

    <p id="today"></p>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:12px 0;">
      <button id="btnPush" style="padding:10px 14px;font-weight:700;">ğŸ”” é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
      <button id="btnTest" style="padding:10px 14px;">è¡¨ç¤ºãƒ†ã‚¹ãƒˆ</button>
    </div>

    <section id="content"></section>
    <hr />
    <small>iPhoneã¯ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã—ãŸå¾Œã«é€šçŸ¥ãŒä½¿ãˆã¾ã™ã€‚</small>
  </main>

  <script src="./app.js"></script>
  <script>
  // â˜…ã‚ãªãŸã®Worker
  const WORKER_ORIGIN = "https://seishotsudoku-push.teruntyo.workers.dev";

  // â˜…ã“ã“ã«ã€ŒVAPID å…¬é–‹éµï¼ˆPublic Keyï¼‰ã€ã‚’è²¼ã‚‹ï¼ˆPrivate Keyã¯çµ¶å¯¾è²¼ã‚‰ãªã„ï¼‰
  const VAPID_PUBLIC_KEY = "BP51V69QOr3LWj2YhzcVO05ojPb9R_VRiMcNciBxPkOXbBtsYZMuJOxgrpVcr755ixYsWK5hVDJLXSgYpTWfM_I
";

  const statusEl = document.getElementById("pushStatus");

  function setStatus(msg){ statusEl.textContent = msg; }

  function urlBase64ToUint8Array(base64String) {
    const padding = "=".repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
    const rawData = atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
    return outputArray;
  }

  async function enablePush(){
    setStatus("æº–å‚™ä¸­â€¦");

    // iPhone Safari ã¯ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ãŒå¿…è¦ï¼ˆiOS 16.4+ï¼‰
    if (!("serviceWorker" in navigator)) {
      setStatus("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Service Workeréå¯¾å¿œã§ã™");
      return;
    }
    if (!("PushManager" in window)) {
      setStatus("ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã¯Pushé€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ï¼ˆiPhoneã¯ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ ãŒå¿…è¦ï¼‰");
      return;
    }

    // 1) SWç™»éŒ²ï¼ˆGitHub Pagesé…ä¸‹ãªã®ã§ ./sw.js ãŒæ­£è§£ï¼‰
    const reg = await navigator.serviceWorker.register("./sw.js");

    // 2) è¨±å¯è¦æ±‚ï¼ˆãƒœã‚¿ãƒ³æŠ¼ä¸‹ã®ä¸­ã§ã‚„ã‚‹ã®ãŒé‡è¦ï¼‰
    const perm = await Notification.requestPermission();
    if (perm !== "granted") {
      setStatus("é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    // 3) è³¼èª­ä½œæˆ
    const sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
    });

    // 4) Workerã¸ä¿å­˜
    const res = await fetch(WORKER_ORIGIN + "/subscribe", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(sub),
    });

    const text = await res.text();
    if (!res.ok) {
      setStatus("subscribeå¤±æ•—: " + res.status + " " + text);
      return;
    }
    setStatus("âœ… é€šçŸ¥è³¼èª­OKï¼ˆKVã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼‰");
  }

  document.getElementById("btnEnablePush").addEventListener("click", enablePush);
</script>

</body>
</html>
