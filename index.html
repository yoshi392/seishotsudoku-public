<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è–æ›¸é€šèª­</title>
  <link rel="manifest" href="./manifest.webmanifest" />
</head>
<body>
  <main style="font-family:system-ui;max-width:720px;margin:24px auto;padding:0 16px;">
    <h1>è–æ›¸é€šèª­</h1>

    <!-- é€šçŸ¥ã¯ã“ã®ãƒœã‚¿ãƒ³1ã¤ã ã‘ -->
    <button id="btnEnable" style="padding:10px 14px;font-weight:700;">ğŸ”” é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
    <button id="btnTest" style="padding:10px 14px;margin-left:8px;">ğŸ”” è¡¨ç¤ºãƒ†ã‚¹ãƒˆï¼ˆPushé€ä¿¡ï¼‰</button>
    <div id="pushStatus" style="margin-top:8px;"></div>

    <hr style="margin:16px 0;" />

    <div id="today" style="font-weight:700;margin:10px 0;"></div>

    <div id="content" style="white-space:pre-wrap;line-height:1.6;"></div>

    <div id="linkArea" style="display:flex;gap:10px;flex-wrap:wrap;margin:14px 0;"></div>
  </main>

  <script>
    // â˜… Worker
    const WORKER_ORIGIN = "https://seishotsudoku-push.teruntyo.workers.dev";

    // â˜… VAPID å…¬é–‹éµï¼ˆæ”¹è¡Œã‚„ç©ºç™½ã¯çµ¶å¯¾NGï¼‰
    const VAPID_PUBLIC_KEY = "BP51V69QOr3LWj2YhzcVO05ojPb9R_VRiMcNciBxPkOXbBtsYZMuJOxgrpVcr755ixYsWK5hVDJLXSgYpTWfM_I";

    const btnEnable = document.getElementById("btnEnable");
    const btnTest = document.getElementById("btnTest");
    const statusEl = document.getElementById("pushStatus");
    const todayEl = document.getElementById("today");
    const contentEl = document.getElementById("content");
    const linkArea = document.getElementById("linkArea");

    function setStatus(msg){ statusEl.textContent = msg; }

    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }

    async function getReg() {
      // â˜… project pagesã¯ scope ã‚’å®‰å®šã•ã›ã‚‹ãŸã‚ã€Œçµ¶å¯¾ãƒ‘ã‚¹ã€ãŒå®‰å…¨
      return navigator.serviceWorker.register("/seishotsudoku/sw.js");
    }

    async function refreshSubStatus() {
      if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
        setStatus("ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã¯Pushé€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ï¼ˆiOSã¯16.4+ / Androidã¯Chromeæ¨å¥¨ï¼‰");
        btnEnable.disabled = true;
        return;
      }
      const reg = await navigator.serviceWorker.ready;
      const sub = await reg.pushManager.getSubscription();
      if (sub) {
        setStatus("âœ… é€šçŸ¥ï¼šæœ‰åŠ¹");
        btnEnable.style.display = "none"; // æœ‰åŠ¹ãªã‚‰ãƒœã‚¿ãƒ³æ¶ˆã™
      } else {
        setStatus("é€šçŸ¥ï¼šæœªè¨­å®š");
        btnEnable.style.display = "";
      }
    }

    async function enablePush(){
      try{
        setStatus("æº–å‚™ä¸­â€¦");

        if (!("serviceWorker" in navigator)) {
          setStatus("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Service Workeréå¯¾å¿œã§ã™");
          return;
        }
        if (!("PushManager" in window)) {
          setStatus("ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã¯Pushé€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ï¼ˆiOSã¯16.4+ / Androidã¯Chromeæ¨å¥¨ï¼‰");
          return;
        }

        const reg = await getReg();

        const perm = await Notification.requestPermission();
        if (perm !== "granted") {
          setStatus("é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼ˆç«¯æœ«è¨­å®šã§é€šçŸ¥ã‚’ONã«ã—ã¦ãã ã•ã„ï¼‰");
          return;
        }

        const sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
        });

        const res = await fetch(WORKER_ORIGIN + "/subscribe", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(sub),
        });

        const t = await res.text();
        if (!res.ok) {
          setStatus("subscribeå¤±æ•—: " + res.status + " " + t);
          return;
        }

        setStatus("âœ… é€šçŸ¥ï¼šæœ‰åŠ¹ï¼ˆç™»éŒ²OKï¼‰");
        btnEnable.style.display = "none"; // æœ‰åŠ¹åŒ–å¾Œã«æ¶ˆã™
      } catch(e){
        setStatus("ã‚¨ãƒ©ãƒ¼: " + (e?.message || String(e)));
      }
    }

    async function sendTestPush(){
      setStatus("ãƒ†ã‚¹ãƒˆé€ä¿¡ä¸­â€¦");
      const res = await fetch(WORKER_ORIGIN + "/send", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          title: "ãƒ†ã‚¹ãƒˆ",
          body: "ã„ã¾å±Šãï¼Ÿ",
          url: location.href
        }),
      });
      const j = await res.json().catch(()=>null);
      if (!res.ok || !j) {
        setStatus("ãƒ†ã‚¹ãƒˆé€ä¿¡å¤±æ•—: " + res.status);
        return;
      }
      setStatus(`ãƒ†ã‚¹ãƒˆé€ä¿¡OKï¼ˆsent:${j.sent} failed:${j.failed}ï¼‰`);
    }

    function renderLinks(payload){
      linkArea.innerHTML = "";
      const mkBtn = (label, href) => {
        const a = document.createElement("a");
        a.textContent = label;
        a.href = href;
        a.target = "_blank";
        a.rel = "noopener";
        a.style.cssText = "display:inline-block;padding:10px 14px;border:1px solid #ccc;border-radius:10px;text-decoration:none;";
        return a;
      };

      // â–¼ ã“ã“ã¯ã€Œä»¥å‰GASã®2ãƒœã‚¿ãƒ³ã€ã‚’å†ç¾ï¼ˆWorkerãŒè¿”ã™URLã‚’ä½¿ã†ï¼‰
      if (payload.studyUrl) linkArea.appendChild(mkBtn("ğŸ“– ãƒã‚¤ãƒ–ãƒ«ã‚¹ã‚¿ãƒ‡ã‚£", payload.studyUrl));
      if (payload.audioUrl) linkArea.appendChild(mkBtn("ğŸ§ ã¨ã‚‚ã«è´ãè–æ›¸", payload.audioUrl));

      if (payload.url) linkArea.appendChild(mkBtn("ğŸ”— é–‹ã", payload.url));
    }

    async function loadToday(){
      const qs = new URLSearchParams(location.search);
      const date = qs.get("date") || "";

      const u = new URL(WORKER_ORIGIN + "/today");
      if (date) u.searchParams.set("date", date);

      const res = await fetch(u.toString(), { cache: "no-store" });
      const payload = await res.json().catch(()=>null);

      if (!res.ok || !payload?.ok) {
        todayEl.textContent = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
        contentEl.textContent = payload?.error || ("HTTP " + res.status);
        return;
      }

      todayEl.textContent = payload.date ? `ğŸ“… ${payload.date}` : "";
      contentEl.textContent = [payload.title, payload.verse, payload.comment].filter(Boolean).join("\n\n");
      renderLinks(payload);
    }

    btnEnable.addEventListener("click", enablePush);
    btnTest.addEventListener("click", sendTestPush);

    // åˆæœŸåŒ–
    (async()=>{
      if ("serviceWorker" in navigator) {
        // readyã‚’å®‰å®šã•ã›ã‚‹ãŸã‚å…ˆã«register
        await getReg().catch(()=>{});
      }
      await refreshSubStatus();
      await loadToday();
    })();
  </script>
</body>
</html>
